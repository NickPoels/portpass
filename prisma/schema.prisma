// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Cluster {
  id           String @id
  name         String
  countries    String // Stored as JSON string
  priorityTier Int
  description  String
  ports        Port[]

  // Strategic & Metadata Fields
  strategicNotes            String?
}

model Port {
  id          String     @id
  name        String
  country     String
  clusterId   String
  cluster     Cluster    @relation(fields: [clusterId], references: [id], onDelete: Cascade)
  description String?
  terminalOperators TerminalOperator[]
  operatorProposals TerminalOperatorProposal[]

  // Location Fields
  latitude    Float?
  longitude  Float?

  // Governance Fields
  portAuthority    String?

  // Identity System Fields
  identityCompetitors     String?  // Stored as JSON string array
  identityAdoptionRate    String? // e.g., "High", "Medium", "Low", "None", or percentage "60%"

  // ISPS Risk Fields
  portLevelISPSRisk      String?  // "Low", "Medium", "High", "Very High"
  ispsEnforcementStrength String?  // "Weak", "Moderate", "Strong", "Very Strong"

  // Strategic Notes
  strategicNotes String?

  // Deep Research Fields
  lastDeepResearchAt      DateTime?
  lastDeepResearchSummary String?
  lastDeepResearchReport  String?
}

model TerminalOperator {
  id              String    @id @default(uuid())
  name            String    // e.g., "PSA Singapore", "BASF Terminal", "Rotterdam Container Terminal"
  portId          String
  port            Port      @relation(fields: [portId], references: [id], onDelete: Cascade)
  
  // Core Fields
  capacity        String?   // e.g., "5M TEU", "10M tons"
  cargoTypes      String    // Stored as JSON string array: ["Container", "Dry Bulk", ...]
  
  // New Fields
  operatorType    String    // "commercial" | "captive"
  parentCompanies String?   // Stored as JSON string array: ["PSA International", "Temasek"] or null
  strategicNotes  String?
  
  // Primary Location (for map centering)
  latitude        Float?
  longitude       Float?
  
  // Location Data (for map visualization - multiple terminal locations)
  locations       String?   // Stored as JSON string array: [{name: "Terminal 1", latitude: 51.5, longitude: 4.0}, ...]
  
  // Deep Research Fields
  lastDeepResearchAt      DateTime?
  lastDeepResearchSummary String?
  lastDeepResearchReport  String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([portId])
  @@index([operatorType])
}

model TerminalOperatorProposal {
  id            String   @id @default(uuid())
  portId        String
  port          Port      @relation(fields: [portId], references: [id], onDelete: Cascade)
  name          String
  operatorType  String?  // "commercial" | "captive"
  parentCompanies String? // Stored as JSON string array
  capacity      String?
  cargoTypes    String?  // Stored as JSON string array
  latitude      Float?
  longitude     Float?
  locations     String?  // Stored as JSON string array
  status        String   // "pending" | "approved" | "rejected"
  createdAt     DateTime @default(now())
  approvedAt    DateTime?

  @@index([portId, status])
  @@index([status])
}

model ParentCompany {
  id            String   @id @default(uuid())
  name          String   @unique // e.g., "PSA International", "DP World", "BASF"
  description   String?
  website       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ResearchJob {
  id            String   @id @default(uuid())
  type          String   // "port" | "terminal_operator"
  entityId      String   // port.id or terminalOperator.id
  clusterId     String?  // For tracking pipeline context
  status        String   // "pending" | "running" | "completed" | "failed" | "cancelled"
  progress      Int      @default(0)
  error         String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  lastHeartbeat DateTime?  // Track when job last reported activity

  @@index([status, type])
  @@index([clusterId])
  @@index([lastHeartbeat])
}
