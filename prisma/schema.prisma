// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Cluster {
  id           String @id
  name         String
  countries    String // Stored as JSON string
  priorityTier Int
  description  String
  ports        Port[]

  // Strategic & Metadata Fields
  strategicNotes            String?
}

model Port {
  id          String     @id
  name        String
  country     String
  clusterId   String
  cluster     Cluster    @relation(fields: [clusterId], references: [id], onDelete: Cascade)
  description String?
  terminals   Terminal[]
  terminalProposals TerminalProposal[]

  // Location Fields
  latitude    Float?
  longitude  Float?

  // Governance Fields
  portAuthority    String?

  // Identity System Fields
  identityCompetitors     String?  // Stored as JSON string array
  identityAdoptionRate    String? // e.g., "High", "Medium", "Low", "None", or percentage "60%"

  // ISPS Risk Fields
  portLevelISPSRisk      String?  // "Low", "Medium", "High", "Very High"
  ispsEnforcementStrength String?  // "Weak", "Moderate", "Strong", "Very Strong"

  // Strategic Notes
  strategicNotes String?

  // Deep Research Fields
  lastDeepResearchAt      DateTime?
  lastDeepResearchSummary String?
  lastDeepResearchReport  String?
}

model Terminal {
  id                      String    @id
  name                    String
  portId                  String
  port                    Port      @relation(fields: [portId], references: [id], onDelete: Cascade)
  latitude                Float
  longitude               Float
  cargoTypes              String // Stored as JSON string
  capacity                String?
  notes                   String?

  // Deep Research Fields
  operatorGroup           String?
  
  lastDeepResearchAt      DateTime?
  lastDeepResearchSummary String?
  lastDeepResearchReport  String?
}

model ResearchJob {
  id            String   @id @default(uuid())
  type          String   // "port" | "terminal"
  entityId      String   // port.id or terminal.id
  clusterId     String?  // For tracking pipeline context
  status        String   // "pending" | "running" | "completed" | "failed" | "cancelled"
  progress      Int      @default(0)
  error         String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  lastHeartbeat DateTime?  // Track when job last reported activity

  @@index([status, type])
  @@index([clusterId])
  @@index([lastHeartbeat])
}

model TerminalProposal {
  id            String   @id @default(uuid())
  portId        String
  port          Port      @relation(fields: [portId], references: [id], onDelete: Cascade)
  name          String
  latitude      Float?
  longitude     Float?
  status        String   // "pending" | "approved" | "rejected"
  createdAt     DateTime @default(now())
  approvedAt    DateTime?

  @@index([portId, status])
  @@index([status])
}
